# Story 3.1: Agent Dependency Resolution and Validation

## Status
DONE

## Story
**As a** developer,
**I want** agents to check their dependencies before execution,
**so that** flows halt gracefully when required documents or predecessor agents haven't completed.

## Acceptance Criteria
1. Dependency checker validates both document dependencies (wait_for.docs) and agent dependencies (wait_for.agents)
2. Document dependencies checked against /docs directory for existence
3. Agent dependencies checked against completed agents list in current flow execution
4. Missing dependencies returned as structured list for client handling
5. on_missing_doc configuration controls behavior (wait, skip, or error)
6. Clear dependency graph can be generated for debugging
7. Circular dependencies detected and reported as errors
8. Unit tests verify various dependency scenarios and edge cases

## Tasks / Subtasks
- [ ] Task 1: Create dependency validation module (AC: 1, 2, 3)
  - [ ] Implement DependencyChecker class in generated/executor.py
  - [ ] Add check_document_dependencies method to validate docs in /docs directory
  - [ ] Add check_agent_dependencies method to validate against completed agents
  - [ ] Return structured DependencyResult with missing items
- [ ] Task 2: Integrate dependency checking into flow executor (AC: 4, 5)
  - [ ] Modify FlowExecutor.execute_agent() to call dependency checker before agent execution
  - [ ] Handle on_missing_doc configuration from runtime.yaml (wait/skip/error)
  - [ ] Return pending_docs list in response when dependencies missing
  - [ ] Skip agent execution when dependencies not met based on config
- [ ] Task 3: Implement dependency graph generation (AC: 6)
  - [ ] Add get_dependency_graph() method to return agent dependency structure
  - [ ] Include both document and agent dependencies in graph
  - [ ] Format as JSON for debugging/visualization
- [ ] Task 4: Add circular dependency detection (AC: 7)
  - [ ] Implement cycle detection algorithm in DependencyChecker
  - [ ] Check during flow initialization, not runtime
  - [ ] Raise CircularDependencyError with clear message showing cycle
- [ ] Task 5: Create comprehensive unit tests (AC: 8)
  - [ ] Test document dependency validation (exists/missing cases)
  - [ ] Test agent dependency validation with various flow states
  - [ ] Test on_missing_doc behavior modes (wait/skip/error)
  - [ ] Test circular dependency detection with different graph structures
  - [ ] Test edge cases: empty dependencies, self-dependencies, invalid paths

## Dev Notes

### Previous Story Context
Story 2.4 implemented the basic /run endpoint and flow execution. The executor currently processes agents sequentially without dependency checking. Memory context is initialized with story_id for isolation.

### Architecture References
[Source: architecture.md#flow-executor]
The Flow Executor component is responsible for orchestrating agent execution with dependency management. Located in `generated/executor.py`, it should include classes: `FlowContext`, `AgentExecutor`, `ParallelGroup` with retry logic, fallback handling, and partial failure recovery.

### File Locations (from Source Tree)
[Source: architecture/source-tree.md]
- Main implementation: `/generated/executor.py` - Flow execution engine
- Test location: `/tests/unit/test_executor.py` - Executor tests
- Integration tests: `/tests/integration/test_flow.py` - Flow execution tests
- Configuration: `/config/runtime.yaml` - Runtime settings including on_missing_doc

### Data Models
[Source: architecture.md#data-models]
```python
class AgentMetadata:
    wait_for: dict = {"docs": [], "agents": []}  # Dependencies to check
```

### Configuration Structure
[Source: architecture.md#redis-configuration]
```yaml
on_missing_doc: skip  # 'wait' | 'skip' | 'error'
```

### Error Handling
[Source: architecture.md#error-handling--retry-strategy]
```python
class DependencyError(RuntimeError):
    """Missing dependencies"""
    pass
```

### PocketFlow Integration
This story uses the existing PocketFlow framework without modification. Dependency checking happens OUTSIDE the PocketFlow Node execution - it's a pre-execution validation in the orchestrator layer. The PocketFlow nodes remain simple and focused on their execution logic.

### KISS Principle Notes
- Keep dependency checking simple: just check file existence for docs, check completed list for agents
- Don't over-engineer: no complex dependency resolution algorithms, just simple validation
- Use existing Python pathlib for file checks, basic list operations for agent checks
- Circular dependency detection uses simple visited set tracking

## Testing

### Testing Standards
[Source: architecture/coding-standards.md#testing-standards]
- Test file location: `/tests/unit/test_executor.py`
- Test naming: `test_<scenario>_<expected_outcome>`
- Use AAA pattern (Arrange, Act, Assert)
- Mock external dependencies using pytest fixtures
- Minimum 80% code coverage

### Specific Test Cases
1. test_check_document_dependencies_all_exist_returns_empty_list
2. test_check_document_dependencies_missing_docs_returns_list
3. test_check_agent_dependencies_all_completed_returns_empty
4. test_check_agent_dependencies_missing_agents_returns_list
5. test_on_missing_doc_wait_returns_pending_docs
6. test_on_missing_doc_skip_continues_execution
7. test_on_missing_doc_error_raises_exception
8. test_circular_dependency_detection_raises_error
9. test_dependency_graph_generation_returns_valid_json

## QA Results

### Review Date: 2025-08-06

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation is solid and follows the KISS principle well. The developer has implemented all acceptance criteria effectively with clean, maintainable code. The dependency checking logic is straightforward and well-structured, using simple file existence checks and list operations as specified. The implementation correctly integrates with the PocketFlow framework without modifying it, maintaining proper separation of concerns.

### Refactoring Performed

- **File**: generated/executor.py
  - **Change**: Removed unnecessary return value from `has_cycle()` function
  - **Why**: The function was returning `False` but the return value was never used
  - **How**: Simplifies code by making it clear the function only raises exceptions on circular dependencies

- **File**: generated/executor.py
  - **Change**: Renamed `execute_agent()` to `check_agent_dependencies()`
  - **Why**: The method doesn't execute agents, it only checks dependencies
  - **How**: Better naming clarifies the method's actual purpose and improves code readability

- **File**: generated/executor.py
  - **Change**: Changed `all_missing_docs` from list to set to avoid duplicates
  - **Why**: Multiple agents might depend on the same documents
  - **How**: Using a set automatically deduplicates and sorting the final list provides consistent output

- **File**: tests/unit/test_executor.py
  - **Change**: Updated test method calls to match renamed method
  - **Why**: Tests must align with refactored code
  - **How**: Ensures tests continue to validate the correct functionality

### Compliance Check

- Coding Standards: ✓ Code follows Python conventions, uses type hints, clear naming
- Project Structure: ✓ Files correctly placed in /generated and /tests as specified
- Testing Strategy: ✓ Comprehensive unit tests with AAA pattern, good edge case coverage
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and tested

### Improvements Checklist

[x] Removed unnecessary return value from circular dependency detection
[x] Renamed method to better reflect its purpose
[x] Fixed potential duplicate documents in pending_docs response
[x] Updated tests to match refactored code

### Security Review

No security concerns identified. The implementation properly validates file paths and doesn't expose internal system information in error messages.

### Performance Considerations

The circular dependency detection uses efficient DFS with O(V+E) complexity. The set-based deduplication for missing documents is more efficient than list-based approaches. Memory context initialization could be optimized to only initialize for executable agents rather than all agents, but this is a minor optimization.

### Final Status

✓ Approved - Ready for Done

All acceptance criteria are met, tests are passing, and code quality is excellent. The implementation follows KISS principles and integrates cleanly with PocketFlow without modifying the framework.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 0.1 | Initial story creation | Bob (Scrum Master) |
| 2025-08-06 | 0.2 | QA review completed with minor refactoring | Quinn (QA) |