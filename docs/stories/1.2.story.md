# Story 1.2: BMAD Markdown Parser with Front-matter Support

## Status
Draft

## Story
**As a** developer,
**I want** to parse BMAD Markdown files and extract agent metadata from YAML front-matter,
**so that** I can understand agent configuration including id, tools, memory scope, and dependencies.

## Acceptance Criteria
1. Parser successfully extracts YAML front-matter from Markdown files using yaml.safe_load()
2. Agent metadata object created with fields: id, description, tools, memory_scope, wait_for, parallel
3. Parser handles missing front-matter gracefully (returns agent with defaults)
4. Markdown content after front-matter preserved as agent prompt text
5. Parser validates required fields and reports clear errors for malformed YAML
6. Unit tests verify parsing of various front-matter configurations
7. Parser can process all .md files in /bmad/agents/ directory in single pass

## Tasks / Subtasks
- [ ] Task 1: Create parser module structure (AC: 1)
  - [ ] Create scripts/parser.py file
  - [ ] Import necessary dependencies (yaml, pathlib)
  - [ ] Set up basic module structure with main parse function
- [ ] Task 2: Implement YAML front-matter extraction (AC: 1, 4)
  - [ ] Detect front-matter boundaries (--- delimiters)
  - [ ] Extract YAML content between delimiters
  - [ ] Preserve remaining Markdown content as prompt text
  - [ ] Use yaml.safe_load() for secure parsing
- [ ] Task 3: Define agent metadata model (AC: 2)
  - [ ] Create Pydantic model or dataclass for agent metadata
  - [ ] Include fields: id, description, tools, memory_scope, wait_for, parallel
  - [ ] Set appropriate defaults for optional fields
- [ ] Task 4: Implement graceful error handling (AC: 3, 5)
  - [ ] Handle missing front-matter (return defaults)
  - [ ] Validate required fields (id is mandatory)
  - [ ] Provide clear error messages for malformed YAML
  - [ ] Log warnings for missing optional fields
- [ ] Task 5: Add batch processing capability (AC: 7)
  - [ ] Implement function to scan /bmad/agents/ directory
  - [ ] Process all .md files found
  - [ ] Return dictionary of parsed agents keyed by id
  - [ ] Handle file I/O errors gracefully
- [ ] Task 6: Create comprehensive unit tests (AC: 6)
  - [ ] Test parsing valid front-matter
  - [ ] Test missing front-matter handling
  - [ ] Test malformed YAML error handling
  - [ ] Test batch processing of multiple files
  - [ ] Test edge cases (empty files, no content after front-matter)

## Dev Notes

### Previous Story Context
Story 1.1 established the project structure. The parser will be placed in `/scripts/parser.py` as defined in the project structure.

### File Location
[Source: architecture/source-tree.md]
```
scripts/
├── parser.py                # BMAD file parser (THIS STORY)
├── config_loader.py         # Configuration loader
├── generator.py             # Code generation logic
└── utils/                   # Script utilities
```

### Agent Metadata Structure
Based on PRD requirements, the agent metadata should include:
- **id** (required): Unique identifier for the agent
- **description**: Brief description of agent's purpose
- **tools**: List of tool names the agent can use
- **memory_scope**: "isolated" or "shared" (default: "isolated")
- **wait_for**: Dependencies object with:
  - docs: List of required document IDs
  - agents: List of agent IDs that must complete first
- **parallel**: Boolean indicating if agent can run in parallel (default: false)

### YAML Front-matter Format Example
```markdown
---
id: analyst
description: Analyzes requirements and creates specifications
tools: [search, write_doc]
memory_scope: isolated
wait_for:
  docs: [prd.md]
  agents: []
parallel: false
---

# Analyst Agent Prompt

The actual Markdown content starts here...
```

### Python Implementation Guidelines
[Source: architecture/coding-standards.md]
- Use snake_case for function names
- Use PascalCase for class names
- Add type hints for all function parameters and returns
- Use Pydantic for data validation if creating models
- Follow KISS principle - keep parser simple and focused

### Required Dependencies
[Source: Story 1.1 - already installed]
- pyyaml>=6.0 (for YAML parsing)
- pydantic>=2.5.0 (for data models)

### Error Handling Strategy
- Use yaml.safe_load() to prevent code injection
- Return sensible defaults when optional fields missing
- Raise clear exceptions for critical errors (missing id, file not found)
- Log warnings for non-critical issues

### Testing
[Source: architecture/tech-stack.md]
- Place tests in `tests/unit/test_parser.py`
- Use pytest fixtures for sample Markdown content
- Test both positive and negative cases
- Aim for 80%+ code coverage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 0.1 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)