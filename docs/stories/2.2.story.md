# Story 2.2: Document Storage API with Markdown Support

## Status
**Draft**

## Story
**As a** developer,
**I want** REST endpoints to store and retrieve Markdown documents,
**so that** agents can read inputs and write outputs that frontends can display.

## Acceptance Criteria
1. GET /doc/{id} retrieves Markdown content from /docs/{id}.md file
2. PUT /doc/{id} stores Markdown content to /docs/{id}.md file
3. GET /doc/{id}/status returns {"exists": bool} for document availability checking
4. Missing documents return 404 with clear error message
5. Document IDs validated to prevent directory traversal attacks
6. Markdown content served with appropriate Content-Type header
7. File I/O operations are async to prevent blocking
8. Unit tests verify CRUD operations and error handling

## Tasks / Subtasks
- [ ] Task 1: Create document storage endpoints (AC: 1, 2, 3)
  - [ ] Implement GET /doc/{id} endpoint for reading documents
  - [ ] Implement PUT /doc/{id} endpoint for writing documents
  - [ ] Implement GET /doc/{id}/status endpoint for existence check
  - [ ] Ensure all endpoints use async file operations with aiofiles
- [ ] Task 2: Implement security validation (AC: 5)
  - [ ] Create document ID validator to prevent path traversal
  - [ ] Reject IDs containing "..", "/", "\\" or other dangerous characters
  - [ ] Allow only alphanumeric, dash, and underscore characters
  - [ ] Add Pydantic model for ID validation
- [ ] Task 3: Handle content types and errors (AC: 4, 6)
  - [ ] Set Content-Type: text/markdown for GET responses
  - [ ] Return 404 with {"detail": "Document not found"} for missing files
  - [ ] Return 400 for invalid document IDs
  - [ ] Handle file system errors gracefully
- [ ] Task 4: Implement async file operations (AC: 7)
  - [ ] Use aiofiles for all file read/write operations
  - [ ] Ensure proper async context managers
  - [ ] Create docs directory if it doesn't exist
  - [ ] Handle concurrent access safely
- [ ] Task 5: Create comprehensive unit tests (AC: 8)
  - [ ] Test successful document creation and retrieval
  - [ ] Test document update operations
  - [ ] Test status endpoint for existing and missing docs
  - [ ] Test security validation rejecting dangerous IDs
  - [ ] Test error handling for various scenarios

## Dev Notes

### Previous Story Context
Story 2.1 created the FastAPI application bootstrap with:
- FastAPI app structure in generated/app.py
- Configuration loading system
- Dynamic agent import functionality
- Health check endpoint

This story adds document storage capabilities that agents will use for reading inputs and writing outputs.

### Document Storage Pattern (KISS Approach)
[Source: CLAUDE.md - KISS principle, minimal dependencies]

Keep the document storage simple - just read/write Markdown files:
```python
from fastapi import APIRouter, HTTPException
from fastapi.responses import PlainTextResponse
import aiofiles
import aiofiles.os
from pathlib import Path
from pydantic import BaseModel, field_validator
import re

router = APIRouter(prefix="/doc", tags=["documents"])

class DocumentId(BaseModel):
    """Validate document IDs for security"""
    id: str
    
    @field_validator('id')
    @classmethod
    def validate_id(cls, v: str) -> str:
        # Prevent path traversal attacks
        if not re.match(r'^[a-zA-Z0-9_-]+$', v):
            raise ValueError('Invalid document ID format')
        if len(v) > 100:  # Reasonable limit
            raise ValueError('Document ID too long')
        return v

DOCS_DIR = Path("docs")
```

### GET Document Endpoint
[Source: docs/architecture/tech-stack.md#file-operations - aiofiles usage]
```python
@router.get("/{doc_id}")
async def get_document(doc_id: str) -> PlainTextResponse:
    """Retrieve a Markdown document"""
    # Validate ID
    try:
        validated = DocumentId(id=doc_id)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    
    file_path = DOCS_DIR / f"{validated.id}.md"
    
    # Check if file exists
    if not file_path.exists():
        raise HTTPException(status_code=404, detail="Document not found")
    
    # Read file asynchronously
    async with aiofiles.open(file_path, mode='r') as f:
        content = await f.read()
    
    return PlainTextResponse(
        content=content, 
        media_type="text/markdown"
    )
```

### PUT Document Endpoint
```python
from pydantic import BaseModel

class DocumentContent(BaseModel):
    content: str
    
    @field_validator('content')
    @classmethod
    def validate_content(cls, v: str) -> str:
        if len(v) > 100_000:  # 100KB limit
            raise ValueError('Document too large')
        return v

@router.put("/{doc_id}")
async def put_document(doc_id: str, doc: DocumentContent):
    """Store a Markdown document"""
    # Validate ID
    try:
        validated = DocumentId(id=doc_id)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    
    # Ensure docs directory exists
    DOCS_DIR.mkdir(exist_ok=True)
    
    file_path = DOCS_DIR / f"{validated.id}.md"
    
    # Write file asynchronously
    async with aiofiles.open(file_path, mode='w') as f:
        await f.write(doc.content)
    
    return {"message": "Document saved", "id": validated.id}
```

### Status Check Endpoint
```python
@router.get("/{doc_id}/status")
async def get_document_status(doc_id: str):
    """Check if a document exists"""
    # Validate ID
    try:
        validated = DocumentId(id=doc_id)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    
    file_path = DOCS_DIR / f"{validated.id}.md"
    
    return {"exists": file_path.exists()}
```

### Integration with Main App
[Source: Story 2.1 - FastAPI app structure]
```python
# In generated/app.py
from generated.documents import router as doc_router

app.include_router(doc_router)
```

### Security Considerations
[Source: docs/architecture/coding-standards.md#security-standards]
- Document IDs are strictly validated to prevent path traversal
- Only alphanumeric, dash, and underscore allowed in IDs
- Content size limited to prevent DoS attacks (100KB default)
- No execution of document content - plain text only
- Async operations prevent blocking under load

### File Structure
[Source: docs/architecture/source-tree.md]
```
generated/
├── app.py                   # FastAPI app (from Story 2.1)
├── documents.py             # THIS STORY - Document storage API
└── agents/                  # Agent modules

docs/                        # Document storage directory
├── *.md                     # Runtime documents
└── architecture/            # Static documentation (not accessed by API)
```

### Testing Strategy
[Source: docs/architecture/coding-standards.md#testing-standards]
```python
# tests/unit/test_documents.py
import pytest
from httpx import AsyncClient
from unittest.mock import AsyncMock, patch

async def test_get_document_success():
    """Test successful document retrieval"""
    # Mock file operations
    with patch('aiofiles.open') as mock_open:
        mock_file = AsyncMock()
        mock_file.read.return_value = "# Test Document"
        mock_open.return_value.__aenter__.return_value = mock_file
        
        # Test endpoint
        response = await get_document("test-doc")
        assert response.status_code == 200
        assert response.headers["content-type"] == "text/markdown"

async def test_validate_document_id():
    """Test ID validation rejects dangerous paths"""
    dangerous_ids = ["../etc/passwd", "../../secret", "path/to/file", "file\\path"]
    for bad_id in dangerous_ids:
        with pytest.raises(ValueError):
            DocumentId(id=bad_id)
```

### Dependencies
[Source: docs/architecture/tech-stack.md]
Already available from Story 1.1:
- fastapi (REST framework)
- aiofiles (async file I/O)
- pydantic (validation)

No new dependencies required.

### Performance Considerations
- Async file operations prevent blocking
- Document size limits prevent memory exhaustion
- Simple file storage scales well for moderate usage
- Consider caching for frequently accessed documents (future story)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 0.1 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*To be populated by QA agent*