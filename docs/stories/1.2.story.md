# Story 1.2: BMAD Markdown Parser with Front-matter Support

## Status
Done

## Story
**As a** developer,
**I want** to parse BMAD Markdown files and extract agent metadata from YAML front-matter,
**so that** I can understand agent configuration including id, tools, memory scope, and dependencies.

## Acceptance Criteria
1. Parser successfully extracts YAML front-matter from Markdown files using yaml.safe_load()
2. Agent metadata object created with fields: id, description, tools, memory_scope, wait_for, parallel
3. Parser handles missing front-matter gracefully (returns agent with defaults)
4. Markdown content after front-matter preserved as agent prompt text
5. Parser validates required fields and reports clear errors for malformed YAML
6. Unit tests verify parsing of various front-matter configurations
7. Parser can process all .md files in /bmad/agents/ directory in single pass

## Tasks / Subtasks
- [x] Task 1: Create parser module structure (AC: 1)
  - [x] Create scripts/parser.py file
  - [x] Import necessary dependencies (yaml, pathlib)
  - [x] Set up basic module structure with main parse function
- [x] Task 2: Implement YAML front-matter extraction (AC: 1, 4)
  - [x] Detect front-matter boundaries (--- delimiters)
  - [x] Extract YAML content between delimiters
  - [x] Preserve remaining Markdown content as prompt text
  - [x] Use yaml.safe_load() for secure parsing
- [x] Task 3: Define agent metadata model (AC: 2)
  - [x] Create Pydantic model or dataclass for agent metadata
  - [x] Include fields: id, description, tools, memory_scope, wait_for, parallel
  - [x] Set appropriate defaults for optional fields
- [x] Task 4: Implement graceful error handling (AC: 3, 5)
  - [x] Handle missing front-matter (return defaults)
  - [x] Validate required fields (id is mandatory)
  - [x] Provide clear error messages for malformed YAML
  - [x] Log warnings for missing optional fields
- [x] Task 5: Add batch processing capability (AC: 7)
  - [x] Implement function to scan /bmad/agents/ directory
  - [x] Process all .md files found
  - [x] Return dictionary of parsed agents keyed by id
  - [x] Handle file I/O errors gracefully
- [x] Task 6: Create comprehensive unit tests (AC: 6)
  - [x] Test parsing valid front-matter
  - [x] Test missing front-matter handling
  - [x] Test malformed YAML error handling
  - [x] Test batch processing of multiple files
  - [x] Test edge cases (empty files, no content after front-matter)

## Dev Notes

### Previous Story Context
Story 1.1 established the project structure. The parser will be placed in `/scripts/parser.py` as defined in the project structure.

### File Location
[Source: architecture/source-tree.md]
```
scripts/
├── parser.py                # BMAD file parser (THIS STORY)
├── config_loader.py         # Configuration loader
├── generator.py             # Code generation logic
└── utils/                   # Script utilities
```

### Agent Metadata Structure
Based on PRD requirements, the agent metadata should include:
- **id** (required): Unique identifier for the agent
- **description**: Brief description of agent's purpose
- **tools**: List of tool names the agent can use
- **memory_scope**: "isolated" or "shared" (default: "isolated")
- **wait_for**: Dependencies object with:
  - docs: List of required document IDs
  - agents: List of agent IDs that must complete first
- **parallel**: Boolean indicating if agent can run in parallel (default: false)

### YAML Front-matter Format Example
```markdown
---
id: analyst
description: Analyzes requirements and creates specifications
tools: [search, write_doc]
memory_scope: isolated
wait_for:
  docs: [prd.md]
  agents: []
parallel: false
---

# Analyst Agent Prompt

The actual Markdown content starts here...
```

### Python Implementation Guidelines
[Source: architecture/coding-standards.md]
- Use snake_case for function names
- Use PascalCase for class names
- Add type hints for all function parameters and returns
- Use Pydantic for data validation if creating models
- Follow KISS principle - keep parser simple and focused

### Required Dependencies
[Source: Story 1.1 - already installed]
- pyyaml>=6.0 (for YAML parsing)
- pydantic>=2.5.0 (for data models)

### Error Handling Strategy
- Use yaml.safe_load() to prevent code injection
- Return sensible defaults when optional fields missing
- Raise clear exceptions for critical errors (missing id, file not found)
- Log warnings for non-critical issues

### Testing
[Source: architecture/tech-stack.md]
- Place tests in `tests/unit/test_parser.py`
- Use pytest fixtures for sample Markdown content
- Test both positive and negative cases
- Aim for 80%+ code coverage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 0.1 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
- Successfully implemented BMAD Markdown parser following KISS principle
- All acceptance criteria met with comprehensive test coverage (24 tests)
- Used modern Pydantic v2 field validators for data validation
- Implemented graceful error handling with specific exception types
- Added CLI interface for manual testing
- Code formatted with Black and linted with Ruff (2 minor naming warnings for field validators - acceptable)

### File List
- scripts/parser.py - Main parser implementation
- tests/unit/test_parser.py - Comprehensive unit tests

## QA Results

### Review Date: 2025-08-06

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation demonstrates excellent software engineering practices with comprehensive testing and clean, maintainable code architecture. The parser follows KISS principles while providing robust error handling and validation. Code is well-documented with Google-style docstrings and follows PEP 8 standards. The developer has successfully implemented all acceptance criteria with thorough edge case coverage.

### Refactoring Performed

No refactoring was required. The implementation is well-structured and follows best practices throughout.

### Compliance Check

- **Coding Standards**: ✓ Fully compliant with PEP 8 and project standards
  - Note: 2 minor Ruff warnings about `cls` parameter in Pydantic field validators are acceptable as this is the correct pattern for Pydantic v2
- **Project Structure**: ✓ Files placed correctly per architecture guidelines
- **Testing Strategy**: ✓ Comprehensive test coverage (24 tests) covering all scenarios
- **All ACs Met**: ✓ All 7 acceptance criteria fully implemented and tested

### Improvements Checklist

All improvements were already implemented by the developer:

- [x] Comprehensive YAML front-matter parsing with yaml.safe_load()
- [x] Robust AgentMetadata model with Pydantic validation
- [x] Graceful error handling with custom exception types
- [x] Batch processing capability for entire directories
- [x] Extensive unit test coverage (24 tests, 100% pass rate)
- [x] Unicode and edge case handling
- [x] CLI interface for manual testing
- [x] Proper logging and warning system
- [x] Clear, self-documenting code with type hints
- [x] Google-style docstrings for all public functions

### Security Review

- ✓ Uses `yaml.safe_load()` to prevent code injection attacks
- ✓ Proper input validation with Pydantic models
- ✓ Path traversal protection in file operations
- ✓ No hardcoded secrets or sensitive information
- ✓ Appropriate error message handling (no data leakage)

### Performance Considerations

- ✓ Efficient file parsing with generator patterns where applicable
- ✓ Memory-conscious approach for large files
- ✓ Proper exception handling to avoid performance degradation
- ✓ Logging configured appropriately for production use
- ✓ No unnecessary object creation or memory leaks

### Final Status

**✓ Approved - Ready for Done**

This implementation exceeds expectations with excellent code quality, comprehensive testing, and robust error handling. The developer has demonstrated strong software engineering practices and delivered a production-ready parser that fully meets all requirements.