# Story 1.3: Workflow and Tools Configuration Loaders

## Status
Ready for Review

## Story
**As a** developer,
**I want** to load optional workflow.yaml and tools.yaml configuration files,
**so that** I can define agent execution sequences and register custom tools for use in generated code.

## Acceptance Criteria
1. Workflow loader reads workflow.yaml and extracts agent execution order and parallel groups
2. Tools loader reads tools.yaml and creates tool registry with module and function references
3. Both loaders handle missing files gracefully (system works without them)
4. Configuration merged with agent metadata from front-matter (front-matter takes precedence)
5. Validation ensures referenced agents and tools exist before generation
6. Clear error messages for invalid workflow definitions or tool references
7. Unit tests verify configuration loading and merging logic

## Tasks / Subtasks
- [x] Task 1: Create configuration loader module (AC: 1, 2)
  - [x] Create scripts/config_loader.py file
  - [x] Import yaml and pathlib dependencies
  - [x] Define load_workflow() function
  - [x] Define load_tools() function
- [x] Task 2: Implement workflow.yaml loader (AC: 1)
  - [x] Parse workflow.yaml from bmad/workflows/ directory
  - [x] Extract flow definitions with agent sequences
  - [x] Identify parallel execution groups
  - [x] Return structured workflow configuration
- [x] Task 3: Implement tools.yaml loader (AC: 2)
  - [x] Parse tools.yaml from bmad/ directory
  - [x] Extract tool definitions with module and function paths
  - [x] Create tool registry dictionary
  - [x] Handle tool parameters and descriptions
- [x] Task 4: Add graceful missing file handling (AC: 3)
  - [x] Return empty/default config when files don't exist
  - [x] Log info messages when using defaults
  - [x] Ensure system continues without configuration files
- [x] Task 5: Implement configuration merging (AC: 4)
  - [x] Merge workflow config with agent metadata
  - [x] Ensure front-matter takes precedence
  - [x] Handle conflicts appropriately
  - [x] Preserve all metadata fields
- [x] Task 6: Add validation logic (AC: 5, 6)
  - [x] Validate agent references in workflows exist
  - [x] Validate tool references are valid Python paths
  - [x] Provide clear error messages for invalid references
  - [x] Check for circular dependencies in workflows
- [x] Task 7: Create unit tests (AC: 7)
  - [x] Test loading valid configuration files
  - [x] Test missing file handling
  - [x] Test configuration merging logic
  - [x] Test validation error cases
  - [x] Test precedence rules

## Dev Notes

### Previous Story Context
- Story 1.1: Project structure created with /bmad directory
- Story 1.2: Parser implemented that returns AgentMetadata objects

The config_loader will work with the parser from story 1.2 to enhance agent metadata with workflow and tool configurations.

### File Locations
[Source: architecture/source-tree.md]
```
scripts/
├── parser.py                # From story 1.2
├── config_loader.py         # THIS STORY
└── generator.py             # Future story

bmad/
├── agents/                  # Agent .md files (parsed in story 1.2)
├── workflows/               # Workflow configurations
│   └── default.yaml        # Default workflow (optional)
└── tools.yaml              # Tool definitions (optional)
```

### Workflow Configuration Format
Simple YAML structure for defining agent execution order:
```yaml
# bmad/workflows/default.yaml
flows:
  default:
    steps:
      - agents: [analyst]      # Step 1: Run analyst
      - agents: [architect, reviewer]  # Step 2: Run in parallel
      - agents: [tester]       # Step 3: Run tester
```

### Tools Configuration Format
Simple tool registry format:
```yaml
# bmad/tools.yaml
tools:
  search:
    module: utils.search
    function: perform_search
    description: Search for information
  
  write_doc:
    module: utils.documents
    function: write_document
    description: Write a document
```

### Integration with Parser
The config_loader should enhance the AgentMetadata from the parser:
```python
# Pseudocode example
agents = parse_agents_directory()  # From story 1.2
workflow = load_workflow()         # This story
tools = load_tools()              # This story
# Merge configurations with front-matter taking precedence
```

### Error Handling Strategy (KISS)
- Missing files: Return empty config, log info, continue
- Invalid YAML: Raise clear exception with file path
- Invalid references: Collect all errors, report together
- No complex recovery logic - fail fast with clear messages

### Dependencies
[Source: Story 1.1 - already installed]
- pyyaml>=6.0 (for YAML parsing)
- No additional dependencies needed

### Testing
[Source: architecture/tech-stack.md]
- Place tests in `tests/unit/test_config_loader.py`
- Use temporary files for test fixtures
- Mock file system for edge cases
- Test both positive and negative scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 0.1 | Initial story creation | Bob (SM) |
| 2025-08-06 | 1.0 | Completed implementation | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- All unit tests passing (55 total tests)
- No import errors
- Linting completed with minor style warnings

### Completion Notes List
- Implemented config_loader.py with KISS principle focus
- Created WorkflowConfig and ToolConfig classes for clean data structures
- Implemented graceful handling for missing configuration files
- Added comprehensive validation with clear error messages
- Ensured front-matter takes precedence over workflow configs
- Created 22 unit tests covering all functionality
- Used PocketFlow framework understanding for future integration

### File List
- scripts/config_loader.py (created)
- tests/unit/test_config_loader.py (created)

## QA Results

### Review Date: 2025-08-06

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation is well-structured and follows KISS principles effectively. The developer has created a clean, maintainable solution with proper separation of concerns, good test coverage, and clear documentation. The code successfully implements all acceptance criteria with appropriate error handling and validation.

### Refactoring Performed

- **File**: scripts/config_loader.py
  - **Change**: Added Optional and Set type hints for better type safety
  - **Why**: Missing type hints can lead to confusion and potential runtime errors
  - **How**: Improves code clarity and enables better IDE support and type checking

- **File**: scripts/config_loader.py
  - **Change**: Introduced custom ConfigurationError exception class
  - **Why**: Generic ValueError doesn't provide enough context for configuration-specific errors
  - **How**: Provides clearer error handling and better separation of error types

- **File**: scripts/config_loader.py
  - **Change**: Created _load_yaml_file helper function to reduce code duplication
  - **Why**: Both load_workflow and load_tools had identical YAML loading logic
  - **How**: DRY principle - single source of truth for YAML loading with consistent error handling

- **File**: scripts/config_loader.py
  - **Change**: Optimized validation with set lookups instead of repeated dictionary key checks
  - **Why**: Multiple iterations over same data structures for validation was inefficient
  - **How**: O(1) set lookups vs O(n) dictionary key checks improves performance for large configs

- **File**: scripts/config_loader.py
  - **Change**: Fixed line length issues and whitespace for PEP8 compliance
  - **Why**: Code consistency and readability standards
  - **How**: Properly formatted multi-line statements maintain 88-character line limit

- **File**: tests/unit/test_config_loader.py
  - **Change**: Updated tests to use ConfigurationError instead of ValueError
  - **Why**: Tests must match the refactored exception handling
  - **How**: Ensures tests accurately validate the new error handling behavior

### Compliance Check

- Coding Standards: ✓ PEP8 compliant after refactoring
- Project Structure: ✓ Files correctly placed in scripts/ and tests/unit/
- Testing Strategy: ✓ Comprehensive unit tests with 22 test cases covering all scenarios
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and tested

### Improvements Checklist

[x] Added proper type hints for Optional parameters
[x] Introduced custom ConfigurationError for better error handling
[x] Reduced code duplication with helper function
[x] Optimized validation performance with set lookups
[x] Fixed all linting issues for PEP8 compliance
[x] Updated tests to match refactored code

### Security Review

No security concerns identified. The implementation properly validates all inputs, uses safe YAML loading, and doesn't expose sensitive information in logs or error messages.

### Performance Considerations

Performance improved through:
- Set-based lookups in validation (O(1) vs O(n))
- Single YAML parsing helper reduces overhead
- Efficient data structure usage throughout

### Final Status

✓ Approved - Ready for Done

Excellent implementation following KISS principles with comprehensive test coverage. All refactoring improvements have been applied and verified. The code is clean, maintainable, and ready for production use.